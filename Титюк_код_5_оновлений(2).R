library(readr)
library(tidyverse)
library(scales)


#???????????? ????? ? dropboxs ? ???? ?????? ?????
url1 <- "https://www.dropbox.com/s/ehiww8h1ted4quz/Odata2019File.csv?dl=1"
download.file(url1, destfile = "./Odata2019File.csv")

url2 <- "https://www.dropbox.com/s/j1ijefd67w51sfq/Odata2020File.csv?dl=1"
download.file(url2, destfile = "./Odata2020File.csv")

#???????????? ????? ????? ? R ?? 2019 ? 2020 ???? ? ??????????? ????????????
Sys.setlocale("LC_CTYPE", "ukrainian")
zno_2019 <- read.csv("Odata2019File.csv", sep=";", encoding="Cyrillic")
zno_2020 <- read.csv("Odata2020File.csv", sep=";", encoding="Cyrillic")

#???????????, ?? ?????????? ?????? ? ???????
summary(colnames(zno_2019) == colnames(zno_2020))

#??????? ? ????? ????? ??????? ? ????? ? ??'??????? ??  
zno_2019 <- cbind(zno_2019, year=rep("2019", times=length(zno_2019$REGTYPENAME)))
zno_2020 <- cbind(zno_2020, year=rep("2020", times=length(zno_2020$REGTYPENAME)))
zno_full <- rbind(zno_2019, zno_2020)

#????????? ? ?????? ???? ???????? ??? ??????, ????????? ???? ??????????? ????, 
#????????? ??? ???????? ??????? null ?? NA, ???? ?? ??????, ??????????? ??????? ?????? ? numeric, ????????????? - ? factor
zno_light <- zno_full %>% 
  select(REGTYPENAME, TerTypeName, EONAME, UkrTestStatus, UkrBall100, UkrPTName,
         histTestStatus,histBall100, histPTName, mathTestStatus, mathBall100, 
         mathPTName, engTestStatus, engBall100, engPTName, year) %>% 
  filter(REGTYPENAME == "????????? ??????? ????????? ????????? ?????? 2019 ????" | 
           REGTYPENAME == "????????? ??????? ????????? ????????? ?????? 2020 ????") %>%
  mutate_all(~na_if(., "null")) %>% 
  mutate(UkrBall100 = sub(",", ".", UkrBall100), histBall100 = sub(",", ".", histBall100), 
         mathBall100 = sub(",", ".", mathBall100), engBall100 = sub(",", ".", engBall100),
         UkrBall100 = as.numeric(UkrBall100), histBall100 = as.numeric(histBall100), mathBall100 = as.numeric(mathBall100), 
         engBall100 = as.numeric(engBall100), REGTYPENAME=as.factor(REGTYPENAME), TerTypeName = as.factor(TerTypeName), 
         UkrTestStatus = as.factor(UkrTestStatus), histTestStatus = as.factor(histTestStatus),
         mathTestStatus=as.factor(mathTestStatus), engTestStatus=as.factor(engTestStatus), year=as.factor(year)) 

#??????? ??? ??????? ???????? ?? ???????, ??? ????????????? ??????????, ??? ???????? ?????? ? ?????? ??????????? ???????
zno_light <- zno_light %>% 
  mutate(Ukr_same = EONAME == UkrPTName, hist_same = EONAME == histPTName, 
         math_same =  EONAME == mathPTName, eng_same =  EONAME == engPTName) %>% 
  mutate(Ukr_same = as.factor(Ukr_same), hist_same = as.factor(hist_same), 
         math_same = as.factor(math_same),eng_same = as.factor(eng_same))

#"??????????" ????? - ???????? ???? ?? ??????? ???????? ? ??????? ??? ???? ???????, 
#???????? ????? ??? ?? ?????? ?????? ? ??????????????? ???, ??? ?? ???????????? ?? ??? ? ??????????? ???????? ??? ??? ?????????? ???? ??????????
ukr_data <- zno_light %>% 
  select(TerTypeName, UkrTestStatus, UkrBall100, Ukr_same, year) %>% 
  mutate(subject = "?????????? ????") %>% 
  rename(TestStatus = UkrTestStatus, Ball = UkrBall100, same_school = Ukr_same) %>% 
  filter(TestStatus %in% c("??????????", "?? ????????", "?? ??????? ?????"))

math_data <- zno_light %>% 
  select(TerTypeName, mathTestStatus, mathBall100, math_same, year) %>% 
  mutate(subject = "??????????") %>% 
  rename(TestStatus = mathTestStatus, Ball = mathBall100, same_school = math_same) %>% 
  filter(TestStatus %in% c("??????????", "?? ????????", "?? ??????? ?????"))

hist_data <- zno_light %>% 
  select(TerTypeName, histTestStatus, histBall100, hist_same, year) %>% 
  mutate(subject = "???????") %>% 
  rename(TestStatus = histTestStatus, Ball = histBall100, same_school = hist_same) %>% 
  filter(TestStatus %in% c("??????????", "?? ????????", "?? ??????? ?????"))

eng_data <- zno_light %>% 
  select(TerTypeName, engTestStatus, engBall100, eng_same, year) %>% 
  mutate(subject = "?????????? ????") %>% 
  rename(TestStatus = engTestStatus, Ball = engBall100, same_school = eng_same) %>% 
  filter(TestStatus %in% c("??????????", "?? ????????", "?? ??????? ?????"))

zno_long <- rbind(ukr_data, math_data, hist_data, eng_data) %>% mutate(subject = as.factor(subject))
levels(zno_long$same_school) <-  c("? ?????? ???????", "? ?????? ???????")

#???????????, ?? ? ??????? ??????? ??? ???????? ??????????? ????, 
#??? ???????? ??? ? ?????? ??????? ??????, ? 2019 ? 2020 ?????  

#????????? ???? ? ??????? ??? ?????????? ?????? ?? ??????? ? ?????????? ??? 2019 ? 2020 ??????
prop_same_school <- zno_long %>%
  group_by(subject, year, same_school) %>%
  summarise(counts=n()) %>%
  mutate(n_total = sum(counts)) %>%
  filter(same_school=="? ?????? ???????") %>%
  rename(n_same_school = counts)

#????? ?? ??????? ? ????????? ???, ??? ??????? ??? ? ?????? ???????, ??? ??????? ???????? 
prop_hist <- prop.test(prop_same_school$n_same_school[c(1,2)], prop_same_school$n_total[c(1,2)]) #???????
prop_eng <- prop.test(prop_same_school$n_same_school[c(3,4)], prop_same_school$n_total[c(3,4)]) #?????????? ????
prop_math <- prop.test(prop_same_school$n_same_school[c(5,6)], prop_same_school$n_total[c(5,6)]) #??????????
prop_ukr <- prop.test(prop_same_school$n_same_school[c(7,8)], prop_same_school$n_total[c(7,8)]) #?????????? ????
#??? ????? ???????? ????????? ??????????? ???????? ???????

#??????? ?????????? ?????? ? ???? ????????? ??? ???????????
options(scipen=999) #???????? ?????????????? ?????
prop_tests <- t(data.frame(unlist(prop_hist[c("estimate", "p.value")]),
                                  unlist(prop_eng[c("estimate", "p.value")]),
                                  unlist(prop_math[c("estimate", "p.value")]),
                                  unlist(prop_ukr[c("estimate", "p.value")])))

#????????? ????? ??'????
rm(list=c("prop_hist", "prop_eng", "prop_math", "prop_ukr"))

write.csv(prop_tests, file="prop_tests.csv")

#???????????, ?? ? ??????? ??????? ??? ??????? ???, ??? ?? ?'?????? ?? ???,
#??? ????????????, ??? ???????? ???? ? ?????? ??????? ??????, ?? ????, ??? ??????? ???? ? ?????? ???????

#????????? ???? ? ??????? ??? ?????????? ?????? ?? ??????? ? ?????????? ??? ????? ?? ????? ?????????
prop_presence <- zno_long %>% 
  filter(year=="2020") %>% 
  group_by(same_school, subject, TestStatus) %>% 
  summarise(counts=n()) %>% 
  mutate(total = sum(counts)) %>% 
  filter(TestStatus == "?? ????????") %>%
  arrange(subject)

#????? ?? ??????? ? ????????? ???, ??? ?? ?'?????? ?? ???, ??????? ??? ?????/?? ????? ???????
#? ??????? ??????? ???????? (???????????????? "less", ???? ???????? ??? ????? ????? ? ??????? ????? ????? ????? ?????
presence_hist <- prop.test(prop_presence$counts[c(1,2)], prop_presence$total[c(1,2)], alternative = "less") #???????
presence_eng <- prop.test(prop_presence$counts[c(3,4)], prop_presence$total[c(3,4)], alternative = "less") #?????????? ????
presence_math <- prop.test(prop_presence$counts[c(5,6)], prop_presence$total[c(5,6)], alternative = "less") #??????????
presence_ukr <- prop.test(prop_presence$counts[c(7,8)], prop_presence$total[c(7,8)], alternative = "less") #?????????? ????

#??????? ?????????? ?????? ? ???? ????????? ??? ???????????
presence_tests <- t(data.frame(unlist(presence_hist[c("estimate", "p.value")]),
                                  unlist(presence_eng[c("estimate", "p.value")]),
                                  unlist(presence_math[c("estimate", "p.value")]),
                                  unlist(presence_ukr[c("estimate", "p.value")])))

#????????? ????? ??'????
rm(list=c("presence_hist", "presence_eng", "presence_math", "presence_ukr"))
write.csv(presence_tests, file="presence_tests.csv")


#???????????, ?? ? ??????? ??????? ??? ??????? ???, ??? ?? ?'?????? ?? ???, 
#??? ???????????? ??????? ??? ??????? (???? ?? ?????) ? ??????? ????? ?? ????

prop_presence_set <-zno_long %>% 
  filter(year=="2020") %>% 
  group_by(same_school, subject, TerTypeName, TestStatus) %>% 
  summarise(counts=n()) %>% 
  mutate(total = sum(counts)) %>% 
  filter(TestStatus == "?? ????????") %>%
  arrange(subject, TerTypeName, same_school)


#????????? ????? ?? ????????? ???????? ??????? ??? ??????? ???, ??? ?? ?'?????? ?? ???
#??????? ??? ??????? (???? ?? ??) ?? ? ??????? ???? ?????????? ??????
hist_urban <- prop.test(prop_presence_set$counts[c(1,2)], 
                        prop_presence_set$total[c(1,2)], alternative = "less") #??????? ? ??????
hist_rural <- prop.test(prop_presence_set$counts[c(3,4)], 
                        prop_presence_set$total[c(3,4)], alternative = "less") #??????? ? ?????
eng_urban <- prop.test(prop_presence_set$counts[c(5,6)], 
                       prop_presence_set$total[c(5,6)], alternative = "less") #?????????? ???? ? ??????
eng_rural <- prop.test(prop_presence_set$counts[c(7,8)], 
                       prop_presence_set$total[c(7,8)], alternative = "less") #?????????? ???? ? ?????
math_urban <- prop.test(prop_presence_set$counts[c(9,10)], 
                        prop_presence_set$total[c(9,10)], alternative = "less") #?????????? ? ??????
math_rural <- prop.test(prop_presence_set$counts[c(11,12)], 
                        prop_presence_set$total[c(11,12)], alternative = "less") #?????????? ? ?????
ukr_urban <- prop.test(prop_presence_set$counts[c(13,14)], 
                       prop_presence_set$total[c(13,14)], alternative = "less") #?????????? ???? ? ??????
ukr_rural <- prop.test(prop_presence_set$counts[c(15,16)], 
                       prop_presence_set$total[c(15,16)], alternative = "less") #?????????? ???? ? ?????

presence_set_tests <- t(data.frame(unlist(hist_urban[c("estimate", "p.value")]),
                                          unlist(hist_rural[c("estimate", "p.value")]),
                                          unlist(eng_urban[c("estimate", "p.value")]),
                                          unlist(eng_rural[c("estimate", "p.value")]),
                                          unlist(math_urban[c("estimate", "p.value")]),
                                          unlist(math_rural[c("estimate", "p.value")]),
                                          unlist(ukr_urban[c("estimate", "p.value")]),
                                          unlist(ukr_rural[c("estimate", "p.value")])))

#????????? ????? ??'????
rm(list=c("hist_urban", "hist_rural", "eng_urban", "eng_rural", "math_urban", "math_rural", "ukr_urban", "ukr_rural"))
write.csv(presence_set_tests, file="presence_set_tests.csv")


#???????????, ?? ????????????? ??????? ???????? ???? ??? ??????? ??? ????, ?? ??????
#???????? ??? ? ???? ??????? ?????? ??? ? ?????? ?????? ??? 2019 ? 2020 ?????
test_hist_2019 = t.test(Ball ~ same_school, data = hist_data %>% 
                          filter(TerTypeName == "?????", TestStatus == "??????????", year=="2019"), alternative = "less") #??????? ? 2019
test_hist_2020 = t.test(Ball ~ same_school, data = hist_data %>% 
                          filter(TerTypeName == "?????", TestStatus == "??????????", year=="2020"), alternative = "less") #??????? ? 2020
test_eng_2019 = t.test(Ball ~ same_school, data = eng_data %>% 
                         filter(TerTypeName == "?????", TestStatus == "??????????", year=="2019"), alternative = "less") #?????????? ???? ? 2019
test_eng_2020 = t.test(Ball ~ same_school, data = eng_data %>% 
                         filter(TerTypeName == "?????", TestStatus == "??????????", year=="2020"), alternative = "less") #?????????? ???? ? 2020
test_math_2019= t.test(Ball ~ same_school, data = math_data %>% 
                         filter(TerTypeName == "?????", TestStatus == "??????????", year=="2019"), alternative = "less") #?????????? ? 2019
test_math_2020 = t.test(Ball ~ same_school, data = math_data %>% 
                          filter(TerTypeName == "?????", TestStatus == "??????????", year=="2020"), alternative = "less") #?????????? ? 2020
test_ukr_2019 = t.test(Ball ~ same_school, data = ukr_data %>% 
                         filter(TerTypeName == "?????", TestStatus == "??????????", year=="2019"), alternative = "less") #?????????? ???? ? 2019
test_ukr_2020 = t.test(Ball ~ same_school, data = ukr_data %>% 
                         filter(TerTypeName == "?????", TestStatus == "??????????", year=="2020"), alternative = "less") #?????????? ???? ? 2020

#??????? ?????????? ?????? ? ???? ????????? ??? ???????????
test_results <- t(data.frame(unlist(test_hist_2019[c("estimate", "p.value")]),
                             unlist(test_hist_2020[c("estimate", "p.value")]), 
                             unlist(test_eng_2019[c("estimate", "p.value")]), 
                             unlist(test_eng_2020[c("estimate", "p.value")]),
                             unlist(test_math_2019[c("estimate", "p.value")]),
                             unlist(test_math_2020[c("estimate", "p.value")]), 
                             unlist(test_ukr_2019[c("estimate", "p.value")]),
                             unlist(test_ukr_2020[c("estimate", "p.value")])))

#????????? ????? ??'????
rm(list=c("test_hist_2019", "test_hist_2020", "test_eng_2019", "test_eng_2020", 
          "test_math_2019", "test_math_2020", "test_ukr_2019", "test_ukr_2020"))
write.csv(test_results, file="test_results.csv")


#²??????????

#???????????? % ??????????? ????, ??? ???????? ??? ? 2019 ? 2020 ????? ? ?????? ??? ?????? ??????? ??????
jpeg(file="??????2.jpeg", width=1000, height=600)
zno_long %>% 
  group_by(subject, year, same_school) %>% 
  summarise(counts=n()) %>% 
  mutate(pct= counts/sum(counts)) %>% 
  ggplot(aes(subject, pct, fill=same_school)) +
  geom_bar(position = "fill", stat="summary") + 
  geom_text(aes(label = percent(pct, accuracy=0.1), digits=1), size=5, vjust = 0) +
  scale_y_continuous(labels = percent) +
  labs(x="??????? ???", y="% ?????????? ????, ?????????????? ?? ?????", fill = "") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 14), 
        legend.position = "bottom", legend.text=element_text(size = 14),
        strip.text.y = element_text(size = 14))+
  scale_fill_brewer(palette="Paired") +
  facet_grid(year ~ .)
dev.off()

#???????????? % ?????????????? ?? ??? ????? ??????????? ????, ??? ?? ????????? ?? ?????
jpeg(file="??????3.jpeg", width=1000, height=600)
zno_long %>% 
  filter(year=="2020") %>% 
  group_by(same_school, subject, TestStatus) %>% 
  summarise(counts=n()) %>% 
  mutate(pct= counts/sum(counts)) %>% 
  filter(TestStatus == "?? ????????") %>% 
  ggplot(aes(subject, pct, fill=same_school)) +
  geom_bar(position = "dodge", stat="identity") + 
  geom_text(aes(label = percent(pct)), position=position_dodge(width=1), vjust = -0.5, size=5) +
  scale_y_continuous(labels = percent) +
  labs(x="??????? ???", y="% ??????????????, ??? ?? ?'??????? ?? ?????", fill = "") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 14), 
        legend.position = "bottom", legend.text=element_text(size = 14),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14))+
  scale_fill_brewer(palette="Paired")
dev.off()

#???????????? % ?????????????? ?? ??? ????? ??????????? ????, ??? ?? ????????? ?? ????? ? ??????? ????? ?? ????
jpeg(file="??????4.jpeg", width=1000, height=600)
zno_long %>% 
  filter(year=="2020") %>% 
  group_by(same_school, subject, TerTypeName, TestStatus) %>% 
  summarise(counts=n()) %>% 
  mutate(pct= counts/sum(counts)) %>% 
  filter(TestStatus == "?? ????????") %>% 
  ggplot(aes(subject, pct, fill=same_school)) +
  geom_bar(position = "dodge", stat="identity") + 
  geom_text(aes(label = scales::percent(pct, accuracy=0.1)), position=position_dodge(width=1), vjust = -0.3, size=5) +
  scale_y_continuous(labels = percent) +
  labs(x="??????? ???", y="% ??????????????, ??? ?? ?'??????? ?? ?????", fill = "") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 14), 
        legend.position = "bottom", legend.text=element_text(size = 14),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14))+
  scale_fill_brewer(palette="Paired") +
  facet_grid(. ~ TerTypeName)
dev.off()

#???????????? ??????????? ???? ??? ????? ?????????, ??? ???????? ???? ? ?????? ??? ? ?????? ??????? ??????
jpeg(file="??????1.jpeg", width=1000, height=900)
zno_long %>% 
  filter(TestStatus == "??????????", TerTypeName == "?????") %>% 
  group_by(subject, TerTypeName, year, same_school) %>% 
  summarise(meanscore = mean(Ball)) %>% 
  ggplot(aes(subject, meanscore, fill=subject)) +
  geom_bar(position = "dodge", stat = "summary") +
  coord_cartesian(ylim=c(130,160)) +
  geom_text(aes(label=round(meanscore, digits=1)), size=5, vjust = 2)+
  labs(x="??????? ???", y="C??????? ??? ???????????, ??? ?????? ?????", fill = "") +
  theme_classic() +
  theme(axis.text.x = element_text(size=0), axis.title.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 14), 
        legend.position = "bottom", legend.text=element_text(size = 14),
        strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14))+
  scale_fill_brewer(palette="Paired") +
  facet_grid(year ~ same_school)
dev.off()  

